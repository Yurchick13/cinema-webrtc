<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cinema Party ¬∑ –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #0a0c0e;
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        #video-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #000;
            position: relative;
        }
        iframe, video {
            width: 100%;
            height: 100%;
            border: none;
        }
        #controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(20, 22, 26, 0.95);
            backdrop-filter: blur(10px);
            padding: 12px 24px;
            border-radius: 50px;
            display: flex;
            gap: 15px;
            align-items: center;
            z-index: 100;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .btn {
            background: #ff4d4d;
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 40px;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn:hover { background: #ff3333; transform: scale(1.02); }
        #info {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.85);
            padding: 12px 24px;
            border-radius: 40px;
            z-index: 1000;
            border: 1px solid #ff4d4d;
            color: #ff4d4d;
            font-weight: bold;
            backdrop-filter: blur(5px);
        }
        #status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.85);
            padding: 12px 24px;
            border-radius: 40px;
            z-index: 1000;
            border: 1px solid #00ff88;
            color: #00ff88;
            backdrop-filter: blur(5px);
        }
        .sync-badge {
            position: fixed;
            bottom: 100px;
            left: 20px;
            background: rgba(255,75,75,0.9);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            color: white;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="info">üé¨ LordFilm | –ö–æ–º–Ω–∞—Ç–∞: <span id="room-id">–∑–∞–≥—Ä—É–∑–∫–∞...</span></div>
    <div id="status">üü° –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</div>
    <div id="sync-badge" class="sync-badge">üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∞–∫—Ç–∏–≤–Ω–∞</div>
    
    <div id="video-container">
        <iframe id="player" allowfullscreen allow="autoplay; fullscreen"></iframe>
    </div>

    <div id="controls">
        <button class="btn" onclick="togglePlay()">‚èØÔ∏è –ü–∞—É–∑–∞/–ü–ª–µ–π</button>
        <button class="btn" onclick="reSync()">üîÑ –°–∏–Ω—Ö—Ä.</button>
    </div>

    <!-- Socket.io –¥–ª—è WebRTC —Å–∏–≥–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    
    <script>
        // ============ –ü–ê–†–ê–ú–ï–¢–†–´ ============
        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('room') || 'default';
        const videoUrl = urlParams.get('url');
        const userId = 'user_' + Math.random().toString(36).substr(2, 9);
        
        let socket = null;
        let player = document.getElementById('player');
        let isHost = false;
        let lastSync = 0;
        
        document.getElementById('room-id').textContent = roomId;
        
        // ============ –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ö WEBRTC –°–ï–†–í–ï–†–£ ============
        function connectWebRTC() {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ —Ö–æ—Å—Ç, –æ—Ç–∫—É–¥–∞ –æ—Ç–∫—Ä—ã—Ç –ø–ª–µ–µ—Ä
            const serverUrl = window.location.origin;
            
            socket = io(serverUrl, {
                query: { room: roomId, user: userId }
            });
            
            socket.on('connect', function() {
                document.getElementById('status').innerHTML = 'üü¢ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
                
                // –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ–º—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ
                socket.emit('join-room', {
                    roomId: roomId,
                    userId: userId,
                    username: 'User_' + userId.substr(0, 4)
                });
            });
            
            // –ü–æ–ª—É—á–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã
            socket.on('room-state', function(state) {
                if (state.hostId === socket.id) {
                    isHost = true;
                    console.log('üé¨ –í—ã —Ö–æ—Å—Ç –∫–æ–º–Ω–∞—Ç—ã');
                }
            });
            
            // –ö—Ç–æ-—Ç–æ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è
            socket.on('peer-joined', function(data) {
                console.log('üë• –£—á–∞—Å—Ç–Ω–∏–∫ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è:', data);
            });
            
            // –ö—Ç–æ-—Ç–æ –≤—ã—à–µ–ª
            socket.on('peer-left', function(peerId) {
                console.log('üëã –£—á–∞—Å—Ç–Ω–∏–∫ –≤—ã—à–µ–ª:', peerId);
            });
            
            // ============ –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –í–ò–î–ï–û ============
            socket.on('video-sync', function(data) {
                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–≤–æ–∏ –∂–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                if (data.userId === userId) return;
                
                console.log('üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è:', data.action, data.time);
                
                // –ü—ã—Ç–∞–µ–º—Å—è —É–ø—Ä–∞–≤–ª—è—Ç—å –ø–ª–µ–µ—Ä–æ–º
                try {
                    if (data.action === 'play') {
                        playVideo();
                    } else if (data.action === 'pause') {
                        pauseVideo();
                    } else if (data.action === 'seek') {
                        seekVideo(data.time);
                    }
                } catch(e) {
                    console.log('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:', e);
                }
            });
            
            socket.on('disconnect', function() {
                document.getElementById('status').innerHTML = 'üî¥ –û—Ç–∫–ª—é—á–µ–Ω–æ';
            });
            
            socket.on('connect_error', function(err) {
                document.getElementById('status').innerHTML = '‚ö†Ô∏è –û—à–∏–±–∫–∞ WebRTC';
                document.getElementById('sync-badge').style.display = 'none';
                console.log('WebRTC –æ—à–∏–±–∫–∞:', err);
            });
        }
        
        // ============ –£–ü–†–ê–í–õ–ï–ù–ò–ï –ü–õ–ï–ï–†–û–ú ============
        function playVideo() {
            // –î–ª—è iframe –ø—ã—Ç–∞–µ–º—Å—è –Ω–∞–∂–∞—Ç—å play (–Ω–µ –≤—Å–µ–≥–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç)
            // –í –∏–¥–µ–∞–ª–µ –Ω—É–∂–µ–Ω YouTube API, –Ω–æ –¥–ª—è LordFilm/iframe —ç—Ç–æ —Å–ª–æ–∂–Ω–æ
            console.log('‚ñ∂Ô∏è Play');
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É –≤—Å–µ–º
            if (socket && isHost) {
                socket.emit('video-action', {
                    roomId: roomId,
                    userId: userId,
                    action: 'play',
                    time: Date.now()
                });
            }
        }
        
        function pauseVideo() {
            console.log('‚è∏Ô∏è Pause');
            
            if (socket && isHost) {
                socket.emit('video-action', {
                    roomId: roomId,
                    userId: userId,
                    action: 'pause',
                    time: Date.now()
                });
            }
        }
        
        function seekVideo(time) {
            console.log('‚è© Seek:', time);
            
            if (socket && isHost) {
                socket.emit('video-action', {
                    roomId: roomId,
                    userId: userId,
                    action: 'seek',
                    time: time
                });
            }
        }
        
        // ============ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨–°–ö–ò–ï –î–ï–ô–°–¢–í–ò–Ø ============
        function togglePlay() {
            if (isHost) {
                // –ü—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É, —Ä–µ–∞–ª—å–Ω—ã–π –ø–ª–µ–µ—Ä –≤ iframe –º—ã –Ω–µ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º
                playVideo();
                alert('‚úÖ –ö–æ–º–∞–Ω–¥–∞ –ø–∞—É–∑—ã/–ø–ª–µ—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤—Å–µ–º');
            } else {
                alert('‚ùå –¢–æ–ª—å–∫–æ —Ö–æ—Å—Ç –º–æ–∂–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å –≤–∏–¥–µ–æ');
            }
        }
        
        function reSync() {
            if (isHost) {
                seekVideo(Date.now());
                alert('üîÑ –ö–æ–º–∞–Ω–¥–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞');
            } else {
                alert('‚ùå –¢–æ–ª—å–∫–æ —Ö–æ—Å—Ç –º–æ–∂–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å');
            }
        }
        
        // ============ –ó–ê–ì–†–£–ó–ö–ê –í–ò–î–ï–û ============
        if (videoUrl) {
            player.src = videoUrl;
            document.getElementById('status').innerHTML = 'üé¨ –ü–ª–µ–µ—Ä –∑–∞–≥—Ä—É–∂–µ–Ω';
        }
        
        // ============ –ó–ê–ü–£–°–ö ============
        connectWebRTC();
        
        // –ï—Å–ª–∏ WebRTC –Ω–µ –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è –∑–∞ 5 —Å–µ–∫—É–Ω–¥, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
        setTimeout(function() {
            if (!socket || !socket.connected) {
                document.getElementById('status').innerHTML = '‚ö†Ô∏è –ë–µ–∑ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏';
                document.getElementById('sync-badge').style.background = 'rgba(255,150,0,0.9)';
                document.getElementById('sync-badge').innerHTML = '‚ö†Ô∏è –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞';
            }
        }, 5000);
    </script>
</body>
</html>
